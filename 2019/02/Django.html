<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="python,web,django,">





  <link rel="alternate" href="/atom.xml" title="Kofe" type="application/atom+xml">






<meta name="description" content="Django 是基于 MVC 模式，由 Python 写成的开源 Web 应用框架。在 Django 中，控制器接受用户输入的部分由框架自行处理，而 Django 里更关注的是模型 ( Model )、模板 ( Template ) 和视图 ( Views )，为此也称其为 MTV 模式的 Web 框架。 事实上，基于 Python 的 Web 框架不仅这一家，如  flask、tornado、w">
<meta name="keywords" content="python,web,django">
<meta property="og:type" content="article">
<meta property="og:title" content="Django：Web 框架从入门到应用">
<meta property="og:url" content="http://www.kofes.cn/2019/02/Django.html">
<meta property="og:site_name" content="Kofe">
<meta property="og:description" content="Django 是基于 MVC 模式，由 Python 写成的开源 Web 应用框架。在 Django 中，控制器接受用户输入的部分由框架自行处理，而 Django 里更关注的是模型 ( Model )、模板 ( Template ) 和视图 ( Views )，为此也称其为 MTV 模式的 Web 框架。 事实上，基于 Python 的 Web 框架不仅这一家，如  flask、tornado、w">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://www.kofes.cn/images/illustration/Programme/2019/02/django_1-1.jpg">
<meta property="og:image" content="http://www.kofes.cn/images/illustration/Programme/2019/02/django_1-2.jpg">
<meta property="og:image" content="http://www.kofes.cn/images/illustration/Programme/2019/02/django_2-1.jpg">
<meta property="og:updated_time" content="2023-02-15T06:35:23.905Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Django：Web 框架从入门到应用">
<meta name="twitter:description" content="Django 是基于 MVC 模式，由 Python 写成的开源 Web 应用框架。在 Django 中，控制器接受用户输入的部分由框架自行处理，而 Django 里更关注的是模型 ( Model )、模板 ( Template ) 和视图 ( Views )，为此也称其为 MTV 模式的 Web 框架。 事实上，基于 Python 的 Web 框架不仅这一家，如  flask、tornado、w">
<meta name="twitter:image" content="http://www.kofes.cn/images/illustration/Programme/2019/02/django_1-1.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.kofes.cn/2019/02/Django.html">





  <title>Django：Web 框架从入门到应用 | Kofe</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?79b30ca99079b04e5fbf1ad6164bf0c1";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kofe</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">御笔记之术铸造超级个体</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.kofes.cn/2019/02/Django.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kofe">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/profile/society_face_version_1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kofe">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Django：Web 框架从入门到应用</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-17T22:44:07+08:00">
                2019-02-17
              </time>
            

            

            
          </span>


	  
            <span class="post-updated">
              &nbsp; | &nbsp; 更新于
              <time itemprop="dateUpdated" datetime="2023-02-15T14:35:23+08:00" content="2023-02-15">
                2023-02-15
              </time>
            </span>
          


          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Project/" itemprop="url" rel="index">
                    <span itemprop="name">Project</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/Django.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/02/Django.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/02/Django.html" class="leancloud_visitors" data-flag-title="Django：Web 框架从入门到应用">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  8,603
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Django 是基于 MVC 模式，由 Python 写成的开源 Web 应用框架。在 Django 中，控制器接受用户输入的部分由框架自行处理，而 Django 里更关注的是模型 ( Model )、模板 ( Template ) 和视图 ( Views )，为此也称其为 MTV 模式的 Web 框架。</p>
<p>事实上，基于 Python 的 Web 框架不仅这一家，如  flask、tornado、web2py 等。对于任何一款框架都有它自身的亮点和缺陷 $^{[2, 3]}$，综合需求、性能要求等诸多因素考量，选择合适的框架即可。比如，我们要开发一款数据库驱动的内容发布与管理系统，借助 Django 的中间件 <a href="https://baike.baidu.com/item/对象关系映射" target="_blank" rel="noopener">ORM</a> 设计优点，使得在操作业务对象时，不需要和复杂的 SQL 语句打交道，只要像平时一样操作对象即可，以高效率完成轻量级后端系统的开发工作。</p>
<a id="more"></a>
<h2 id="教学资源"><a href="#教学资源" class="headerlink" title="教学资源"></a>教学资源</h2><ul>
<li>📺 | 视频 | <a href="https://www.bilibili.com/video/av22606568/?p=3" target="_blank" rel="noopener">老男孩.Python 全栈: Django 框架入门到应用. 2018. bilibili.com</a></li>
<li>📄 | 文章 | <a href="https://docs.djangoproject.com/zh-hans/2.1/" target="_blank" rel="noopener">Django.Django 快速入门&amp;中文使用文档. djangoproject.com</a></li>
</ul>
<h2 id="快速上手"><a href="#快速上手" class="headerlink" title="快速上手"></a>快速上手</h2><h3 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h3><ul>
<li><p>安装：命令行模式安装 ( Mac / Linux 用户注意管理员权限 )</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install django</span><br><span class="line">pip install django == x.xx.xx</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>配置：配置 Django 项目并初次启动它。</p>
<ul>
<li><p>创建项目：可通过命令模式启动项目 ( 多用于部署环境 )，也可通过 PyCharm 启动、运行项目。</p>
<ul>
<li>命令模式：<code>django-admin startproject mysite</code></li>
<li><p>PyCharm：通过 PyCharm 一步到位，即 <code>新建工程 &gt; Django &gt; ( 建立单独的 Venv ) &gt; mysite</code>。</p>
<blockquote>
<p>Virtualenv：为一个应用创建一套“隔离”的 Python 运行环境，具体配置方法可参考 [1]。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>项目目录结构说明</p>
<ul>
<li><code>mysite</code>：同名目录，它是一个纯 Python 包。它的名字就是当你引用它内部任何东西时需要用到的 Python 包名，比如 mysite.urls。</li>
<li><code>__init__.py</code>：空文件，标识这个目录应识别为 Python 包。</li>
<li><code>settings.py</code>：Django 的项目配置文件。</li>
<li><code>urls.py</code>：Django 项目的 URL 声明。</li>
<li><code>wsgi.py</code>：Web 服务网关接口 ( Socket )。</li>
<li><p><code>manage.py</code>：对网络所有管理是通过其来实现的。</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysite</span><br><span class="line">  ├─── mysite</span><br><span class="line">  │ ├── init__.py</span><br><span class="line">  │ ├── settings.py</span><br><span class="line">  │ ├── urls.py</span><br><span class="line">  │ ├── wsgi.gy</span><br><span class="line">  └─── manage.py</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>使用：以命令模式启动本地服务器为例，当然可以使用 Pycharm 一键运行。</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py runserver 127.0.0.1:8000</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="请求与响应"><a href="#请求与响应" class="headerlink" title="请求与响应"></a>请求与响应</h3><h4 id="返回内容至页面"><a href="#返回内容至页面" class="headerlink" title="返回内容至页面"></a>返回内容至页面</h4><p>返回内容 ( Html 元素或对象 ) 至页面，代码应包含在 <code>urls.py</code> 文件中。</p>
<ul>
<li><p>下述是返回字符串或 Html 元素的示例代码：</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">arguments:</span></span><br><span class="line"><span class="string">	@param request 放置用户请求相关的所有信息</span></span><br><span class="line"><span class="string">@return 响应与返回处理结果</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">info</span><span class="params">(request)</span>:</span></span><br><span class="line">	<span class="comment"># 1. 可返回字符串</span></span><br><span class="line">	<span class="keyword">return</span> HttpResponse(<span class="string">"Hello World!"</span>)</span><br><span class="line">	<span class="comment"># 2. 可返回 Html 元素 (对象)</span></span><br><span class="line">	<span class="comment"># return HttpResponse("&lt;input type='text' /&gt;")</span></span><br><span class="line">	</span><br><span class="line"><span class="comment"># 访问 Site 根目录</span></span><br><span class="line">urlpatterns = [ url(<span class="string">''</span>, info), ]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="返回独立-Html-页面"><a href="#返回独立-Html-页面" class="headerlink" title="返回独立 Html 页面"></a>返回独立 Html 页面</h4><p>返回独立 Html 页面，且尝试把数据返回到页面中。</p>
<ul>
<li>Html 页面放置 <code>tempates</code> 目录下；</li>
<li><p><code>settings.py</code> 中配置模板的路径 ( 告诉程序网页模板在哪个目录下 )；</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TEMPLATES = [</span><br><span class="line">	<span class="string">'DIRS'</span>: [os.path.join(BASE_DIR, <span class="string">'templates'</span>)]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p><code>urs.py</code> 中加入调用代码，绑定请求地址与处理函数；</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">info</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># render 能抓取页面全部信息 ( 它也调用了 HttpResponse )</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'info.html'</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>若要引用资源目录，如存放 images、css 等，则需要在 <code>settings.py</code> 中加入声明语句。</p>
<p>  引用资源时，需要加入 <code>static</code>。例如 <code>&lt;link rel=&quot;stylesheet&quot; href=&quot;static/style.css&quot;&gt;</code>。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">STATIC_URL = <span class="string">'/static/'</span></span><br><span class="line">STATICFILES_DIRS = (</span><br><span class="line">    <span class="comment"># '文件名' 是自由命名的，这里取 'static' 是为了统一命名</span></span><br><span class="line">    os.path.join(BASE_DIR, <span class="string">'static'</span>), </span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="简单登录功能"><a href="#简单登录功能" class="headerlink" title="简单登录功能"></a>简单登录功能</h3><blockquote>
<p>本实例主要展示的是，在 Django 框架下 Web 前后端的交互过程。</p>
</blockquote>
<ul>
<li><p>首先，我们在 <code>urls.py</code> 中配置路由关系，并绑定路由触发的函数以实现功能。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> HttpResponse, render, redirect</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line"><span class="comment"># 首次加载页面调用的函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(request)</span>:</span></span><br><span class="line">	<span class="comment"># GET 可通过请求的链接地址传参，如 url?page=1</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="string">'GET'</span> == request.method):</span><br><span class="line">		<span class="comment">## render() 是抓取页面全部信息 ( 它也调用了 HttpResponse )</span></span><br><span class="line">		<span class="keyword">return</span> render(request, <span class="string">'login.html'</span>)</span><br><span class="line">				</span><br><span class="line"><span class="comment"># 登录成功后把数据回传到目标页面</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">	user = request.POST</span><br><span class="line">	<span class="keyword">return</span> render(request, <span class="string">'index.html'</span>, &#123;</span><br><span class="line">		<span class="string">'username'</span>: str(user.get(<span class="string">'username'</span>)),</span><br><span class="line">		<span class="string">'password'</span>: &#123;</span><br><span class="line">			<span class="string">'origin'</span>: user.get(<span class="string">'password'</span>),</span><br><span class="line">			<span class="string">'encode'</span>: base64.b64encode( (user.get(<span class="string">'password'</span>) + user.get(<span class="string">'password'</span>)).encode(<span class="string">'utf-8'</span>) )</span><br><span class="line">		&#125;&#125;</span><br><span class="line">	)</span><br><span class="line">   </span><br><span class="line"><span class="comment"># path(相对地址, 调用函数)，如请求地址为根目录，故这里填写 '' </span></span><br><span class="line">urlpatterns = [ </span><br><span class="line">    path(<span class="string">''</span>, login), </span><br><span class="line">    path(<span class="string">'index'</span>, index), </span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>最后附上相关联的 <code>login.html</code> 和 <code>index.html</code>。</p>
  <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- login.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>Information Page<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"static/css/style.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">h2</span>&gt;</span>Hello World!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">h2</span>&gt;</span>Welcome to use the exhibation page.<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">action</span>=<span class="string">"index"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">type</span>=<span class="string">"text"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">type</span>=<span class="string">"password"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">"login"</span> <span class="attr">type</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- index.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>Home Index<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"static/css/style.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>	</span><br><span class="line">	<span class="comment">&lt;!-- 1. 模板中接受函数体返回的属性 --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- &#123;&#123;&#125;&#125; 特殊占位符: Django render() 会自动解析它 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">h2</span>&gt;</span>username<span class="tag">&lt;/<span class="name">h2</span>&gt;</span> &#123;&#123; username &#125;&#125;</span><br><span class="line">	<span class="tag">&lt;<span class="name">h2</span>&gt;</span>password<span class="tag">&lt;/<span class="name">h2</span>&gt;</span> &#123;&#123; password.origin &#125;&#125; =&gt; &#123;&#123; password.encode &#125;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="comment">&lt;!-- 换行 --&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- 2. 模板中调用对象的方法和属性，例如循环体 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">td</span>&gt;</span>Username<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; username &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">		&#123;% for key, value in password.items %&#125;</span><br><span class="line">		<span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">td</span>&gt;</span>Password:&#123;&#123; key &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; value &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">		&#123;% endfor %&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="增删改查系统"><a href="#增删改查系统" class="headerlink" title="增删改查系统"></a>增删改查系统</h3><blockquote>
<p>本实例主要展示的是 Python 与数据库的交互过程。</p>
</blockquote>
<h4 id="建立数据表"><a href="#建立数据表" class="headerlink" title="建立数据表"></a>建立数据表</h4><p>数据关系：这里以学生 ( Student )、任教老师 ( Teacher ) 和课程 ( Course ) 三个实体为例，构建数据表。</p>
<ul>
<li>ER 图，如图 4-1 所示：<ul>
<li>学生可以选修多门课程，一门课程可以多个学生参与，即多对多关系。</li>
<li>老师只能任教一门课程，但是一门课程有多个老师开课，即一对多关系。</li>
</ul>
</li>
</ul>
<p><img src="/images/illustration/Programme/2019/02/django_1-1.jpg" alt="django_1-1"></p>
<center>图 1-1 演示数据库的数据关系</center>

<ul>
<li>关系模式：<ul>
<li>学生实体(学生序号, 学生姓名) == t<em>student(_sid</em>, name)</li>
<li>课程实体(课程序号, 课堂名称) == t<em>course(_cid</em>, name)</li>
<li>老师实体(老师序号, 老师姓名) == t<em>teacher(_tid</em>, name, cid)</li>
<li>选课关系(学生序号, 课程序号, 成绩) == Student2Course(<em>sid</em>, <em>cid</em>, score)</li>
</ul>
</li>
</ul>
<h4 id="前-后端交互原理"><a href="#前-后端交互原理" class="headerlink" title="前 / 后端交互原理"></a>前 / 后端交互原理</h4><ul>
<li>Web 程序的前后端交互原理如图 4-2 所示。</li>
</ul>
<p><img src="/images/illustration/Programme/2019/02/django_1-2.jpg" alt="django_1-2"></p>
<center>图 1-2 Web 程序的前后端交互原理</center>

<h4 id="原生代码操作数据"><a href="#原生代码操作数据" class="headerlink" title="原生代码操作数据"></a>原生代码操作数据</h4><ul>
<li>Python 的 MySQL 驱动有 <code>MySQLdb</code>、<code>PyMySQL</code> 以及 <code>MySQLClient</code>。</li>
<li><p>在 Python 2.7 版本，主要是用 MySQLdb，而 Python 3.x 版本多数使用 PyMySQL 以及 MySQLClient。两者操作风格类似，本文则以 PyMySQL 展开探讨。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 封装连接数据库的信息</span></span><br><span class="line">db_infos = &#123;</span><br><span class="line">	<span class="string">'host'</span>: <span class="string">"IP 地址"</span>,</span><br><span class="line">	<span class="string">'port'</span>: <span class="number">3306</span>,</span><br><span class="line">	<span class="string">'user'</span>: <span class="string">"数据库账户"</span>,</span><br><span class="line">	<span class="string">'password'</span>: <span class="string">"数据库密码"</span>,</span><br><span class="line">	<span class="string">'db'</span>: <span class="string">"数据库名称"</span>,</span><br><span class="line">	<span class="string">'charset'</span>: <span class="string">"utf8"</span>,</span><br><span class="line">	<span class="string">'cursorclass'</span>: pymysql.cursors.DictCursor</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line">db = pymysql.connect(db_infos)</span><br><span class="line"></span><br><span class="line">SQL = <span class="string">"SELECT * FROM t_student"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	<span class="keyword">with</span> db.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">		cursor.excute(SQL) <span class="comment"># 执行 SQL 语句</span></span><br><span class="line">		db.commit() <span class="comment"># 提交修改数据请求</span></span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">	db.rollback() <span class="comment"># 回滚</span></span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">	db.close() <span class="comment"># 关闭数据库连接</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="Ajax-方式交互数据"><a href="#Ajax-方式交互数据" class="headerlink" title="Ajax 方式交互数据"></a>Ajax 方式交互数据</h4><ul>
<li><p>借助 Ajax，实现数据的本地刷新，而不需要重新加载、渲染网页。</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    url: <span class="string">'提交地址'</span>,</span><br><span class="line">    type: <span class="string">'POST'</span> <span class="comment">// POST / GET</span></span><br><span class="line">    data: &#123;<span class="string">'key_1'</span>: <span class="string">'value_1'</span>, ..., <span class="string">'key_n'</span>: <span class="string">'value_n'</span> &#125;</span><br><span class="line">    success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 当前服务端处理数据，自动执行回调函数</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="框架正文"><a href="#框架正文" class="headerlink" title="框架正文"></a>框架正文</h2><p>本章节的内容参考 <a href="https://docs.djangoproject.com/zh-hans/2.1/" target="_blank" rel="noopener">Django 官方文档 v2.1</a> 整理所得，即把模型、模板和视图的概念更加细化，通过一个投票应用的实例以讲述如何搭建一个 <code>MTV模式</code> 的 Web 框架，如图 3-1 所示。</p>
<p><img src="/images/illustration/Programme/2019/02/django_2-1.jpg" alt="django_2-1"></p>
<center>图 2-1 MTV 模式的 Web 框架</center>

<h3 id="数据库配置"><a href="#数据库配置" class="headerlink" title="数据库配置"></a>数据库配置</h3><ul>
<li><p>编辑 <code>mysite/settings.py</code> 文件前，先设置 <a href="https://docs.djangoproject.com/zh-hans/2.1/ref/settings/#std:setting-TIME_ZONE" target="_blank" rel="noopener">TIME_ZONE</a> 为你自己时区，可参考 Wikipedia 的 <a href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones" target="_blank" rel="noopener">List of time zones</a>。</p>
<blockquote>
<p>新建立的项目，默认时区为 <code>UTC</code>。</p>
</blockquote>
</li>
<li><p>打开 <code>mysite/settings.py</code>，通常这个配置文件使用 SQLite 作为默认数据库。</p>
<ul>
<li><code>ENGINE</code>：选值 <code>django.db.backends.sqlite3</code>。</li>
<li><p><code>NAME</code>：数据库的名称。若使用 <a href="https://baike.baidu.com/item/SQLite/375020?fr=aladdin" target="_blank" rel="noopener">SQLite</a>，数据库将是你电脑上的一个文件，NAME 应该是此文件的绝对路径 + 文件名，默认值 <code>os.path.join(BASE_DIR, &#39;db.sqlite3&#39;)</code> 将会把数据库文件储存在项目的根目录。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.sqlite3'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: os.path.join(BASE_DIR, <span class="string">'db.sqlite3'</span>),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>若使用了 SQLite 以外的数据库，请确认在使用前已经 <code>创建了数据库</code>。连接到其他数据库时 ( MySQL，Oracle 或 PostgreSQL )，参考 <a href="https://docs.djangoproject.com/zh-hans/2.1/ref/settings/#std:setting-DATABASE-ENGINE" target="_blank" rel="noopener">ENGINE</a> 的设置来连接其他数据库。例如连接 MySQL 的配置如下所示：</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'mydatabase'</span>,</span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">'mydatabaseuser'</span>,</span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">'mypassword'</span>,</span><br><span class="line">        <span class="string">'HOST'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'PORT'</span>: <span class="string">'3306'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>此外，关注一下文件头部的 <code>INSTALLED_APPS</code> 设置项。这里包括了项目中启用的所有 Django 应用。应用能在多个项目中使用，也可以打包并且发布应用，让别人使用它们。通常 INSTALLED_APPS 默认包括了以下 Django 的自带应用：</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="comment"># 因为 ApplicationConfig 类写在文件 polls/apps.py 中，</span></span><br><span class="line">    <span class="comment"># 所以它的点式路径是 'polls.apps.ApplicationConfig'</span></span><br><span class="line">    <span class="string">'polls.apps.ApplicationConfig'</span>,	<span class="comment"># 激活模型</span></span><br><span class="line">    <span class="string">'django.contrib.admin'</span>,		<span class="comment"># 管理员站点</span></span><br><span class="line">    <span class="string">'django.contrib.auth'</span>,		<span class="comment"># 认证授权系统</span></span><br><span class="line">    <span class="string">'django.contrib.contenttypes'</span>,	<span class="comment"># 内容类型框架</span></span><br><span class="line">    <span class="string">'django.contrib.sessions'</span>,		<span class="comment"># 会话框架</span></span><br><span class="line">    <span class="string">'django.contrib.messages'</span>,		<span class="comment"># 消息框架</span></span><br><span class="line">    <span class="string">'django.contrib.staticfiles'</span>,	<span class="comment"># 管理静态文件的框架</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>默认开启的某些应用需要至少一个数据表，故在使用他们前需要在数据库中创建一些表。请执行命令：</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> MacOS / Linux</span></span><br><span class="line">python manage.py migrate</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Windows ( 下述代码同理，基本上 <span class="string">"py"</span> 对应于 <span class="string">"python"</span> )</span></span><br><span class="line">py manage.py migrate</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="模型和站点管理"><a href="#模型和站点管理" class="headerlink" title="模型和站点管理"></a>模型和站点管理</h3><h4 id="创建模型"><a href="#创建模型" class="headerlink" title="创建模型"></a>创建模型</h4><ul>
<li><p>定义模型 ( Model )，即数据库结构设计和附加的其它元数据。在 Django 中，你只需要定义数据模型，其中的实现代码不用理会，它们会自动从模型生成。</p>
<blockquote>
<p>模型是真实数据的简单明确的描述，它包含了储存的数据所必要的字段和行为。</p>
</blockquote>
</li>
<li><p>例如，在本案例中 ( 投票应用 )，需要创建两个模型：问题 Question 和选项 Choice。</p>
<ul>
<li>Question 模型：包括问题描述和发布时间。</li>
<li>Choice 模型：包括选项描述和当前得票数。每个选项属于一个问题 ( 一对一关系 )。</li>
</ul>
</li>
<li><p>这些概念可通过 Python 类来描述。按照下面的例子来编辑 <code>polls/models.py</code> 文件：</p>
<ul>
<li>每个模型被表示为 <code>django.db.models.Model</code> 类的子类。每个模型有一些类变量，它们都表示模型里的一个数据库字段。</li>
<li>每个字段都是 <code>Field</code> 类的实例，这将告诉 Django 每个字段要处理的数据类型。比如，字符字段被表示为 <code>CharField</code>，日期时间字段被表示为 <code>DateTimeField</code>。</li>
<li><p>定义某些 Field 类实例需要参数，例如 CharField 需要一个 max_length 参数。</p>
<blockquote>
<p>这个参数的用处不止于用来定义数据库结构，也用于验证数据。</p>
</blockquote>
</li>
<li><p>Django 支持所有常用的数据库关系：一对一、一对多和多对多，我们使用外键 <code>ForeignKey</code> 定义了一个关系。例如，每个 Choice 对象都关联到一个 Question 对象。</p>
</li>
<li><p>数据表最重要的 <code>主键</code> 会被自动创建，当然也可以自定义。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Question</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    question_text = models.CharField(max_ length=<span class="number">200</span>)</span><br><span class="line">    pub_date = models.DateTimeField(<span class="string">'date published'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Question.objects.all() 返回信息对我们用处不大，如下所示：</span></span><br><span class="line">    <span class="comment"># &lt;QuerySet [&lt;Question: Question object (1)&gt;]&gt;</span></span><br><span class="line">    <span class="comment"># 可尝试通过 __str__() 方法返回一些字段信息</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> self.question_text</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Choice</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    question = models.ForeignKey(Question, on_delete=models.CASCADE)</span><br><span class="line">    choice_text = models.CharField(max_length=<span class="number">200</span>)</span><br><span class="line">    votes = models.IntegerField(default=<span class="number">0</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> self.choice_text</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="激活模型"><a href="#激活模型" class="headerlink" title="激活模型"></a>激活模型</h4><ul>
<li><p>从上述用于创建模型的代码可知，Django 可实现：</p>
<ul>
<li>为这个应用创建数据库 <code>schema</code> ( 生成 CREATE TABLE 语句 )。</li>
<li>创建与 Question 和 Choice 对象与数据库进行交互的 <code>API</code> ( Python 版本 )。</li>
</ul>
</li>
<li><p>但是首先得把 polls 应用安装到我们的项目里。具体地， 在文件 <code>mysite/settings.py</code> 中 <code>INSTALLED_APPS</code> 子项添加点式路径：</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="comment"># 因为 ApplicationConfig 类写在文件 polls/apps.py 中，</span></span><br><span class="line">    <span class="comment"># 所以它的点式路径是 'polls.apps.ApplicationConfig'</span></span><br><span class="line">    <span class="string">'polls.apps.ApplicationConfig'</span>,	<span class="comment"># 激活模型</span></span><br><span class="line">    <span class="string">'django.contrib.admin'</span>,			<span class="comment"># 管理员站点</span></span><br><span class="line">    <span class="string">'django.contrib.auth'</span>,			<span class="comment"># 认证授权系统</span></span><br><span class="line">    <span class="string">'django.contrib.contenttypes'</span>,	<span class="comment"># 内容类型框架</span></span><br><span class="line">    <span class="string">'django.contrib.sessions'</span>,		<span class="comment"># 会话框架</span></span><br><span class="line">    <span class="string">'django.contrib.messages'</span>,		<span class="comment"># 消息框架</span></span><br><span class="line">    <span class="string">'django.contrib.staticfiles'</span>,	<span class="comment"># 管理静态文件的框架</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在你的 Django 项目会包含 polls 应用。接着通过运行 <code>makemigrations</code> 命令，Django 会检测你对模型文件的修改 ( 在这种情况下刚创建的可理解为最新修改的  )，并且把修改的部分储存为一次 <code>迁移</code>。</p>
<blockquote>
<p>迁移：Django 对于模型定义，也就是你的数据库结构的变化的储存形式。它们其实也只是一些你磁盘上的文件。</p>
</blockquote>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations polls</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>Django 有一个自动执行 <code>数据库迁移</code> 并同步管理你的数据库结构的命令：</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>当然，你是否会好奇，迁移是怎样的过程，迁移命令会执行哪些 SQL 语句？那么，<code>sqlmigrate</code> 命令接收一个迁移的名称，然后返回对应的 SQL。</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> sqlmigrate 命令</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 并没有真正在数据库中的执行迁移，它只是把命令输出到屏幕上</span></span><br><span class="line">python manage.py sqlmigrate polls 0001</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>输入以上命令，你将看到如下结果 ( 格式化输出 SQL )：</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 输出示例使用的是 PostgreSQL / MySQL --</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="comment">-- Create model Choice</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">"polls_choice"</span> (</span><br><span class="line">    <span class="string">"id"</span> <span class="built_in">serial</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    <span class="string">"choice_text"</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">"votes"</span> <span class="built_in">integer</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">-- Create model Question</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">"polls_question"</span> (</span><br><span class="line">    <span class="string">"id"</span> <span class="built_in">serial</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    <span class="string">"question_text"</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">"pub_date"</span> <span class="built_in">timestamp</span> <span class="keyword">with</span> <span class="built_in">time</span> zone <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">-- 省略剩余语句，具体可自行测试 --</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>从格式化的 SQL 语句可注意到：</p>
<ul>
<li><p>数据库的表名是由应用名 ( polls ) 和模型名的小写形式 ( question 和 choice ) 连接而来。</p>
</li>
<li><p>主键 ( id ) 会被自动创建，当然你也可以自定义。</p>
</li>
<li><p>默认 Django 会在外键字段名后追加字符串 “_id” ，同样也可以自定义。</p>
</li>
<li><p>生成的 SQL 语句是为你所用的数据库定制的，所以那些和数据库有关的字段类型，比如 auto_increment ( MySQL )、 serial ( PostgreSQL ) 和 integer primary key autoincrement ( SQLite )，Django 会帮你自动处理。那些和引号相关的事情，比如使用单引号还是双引号，也一样会被自动处理。</p>
</li>
</ul>
</li>
<li><p>总结：迁移是非常强大的功能，它能让你在开发过程中持续的改变数据库结构而不需要重新删除和创建表，即它专注于使数据库平滑升级而不会丢失数据。<strong>现在改变模型只需要记住这三步</strong>：</p>
<ul>
<li><p>编辑 <code>models.py</code> 文件，改变模型。</p>
</li>
<li><p>运行 <code>python manage.py makemigrations</code> 为模型的改变 <code>生成</code> 迁移文件。</p>
</li>
<li><p>运行 <code>python manage.py migrate</code> 来 <code>应用</code> 数据库迁移。</p>
</li>
</ul>
</li>
</ul>
<h4 id="数据操作"><a href="#数据操作" class="headerlink" title="数据操作"></a>数据操作</h4><ul>
<li>当完成 <code>创建模型</code> ( 定义数据实体和数据关系 ) 与 <code>激活模型</code> ( 模型驱动自动生成 SQL 代码 ) 的工作，即表明数据表已建立起来，紧接着便可操作数据库了。</li>
<li>关于操作数据库的 Python API 所有细节可在 <a href="https://docs.djangoproject.com/zh-hans/2.1/topics/db/queries/" target="_blank" rel="noopener">Database API For Python</a> 参考文档中找到。</li>
</ul>
<h5 id="创建对象"><a href="#创建对象" class="headerlink" title="创建对象"></a>创建对象</h5><ul>
<li><p>假设模型存在于文件中 mysite/polls/models.py：</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> polls.models <span class="keyword">import</span> Choice, Question</span><br><span class="line"><span class="comment"># 使用模型类的关键字参数对其实例化，再调用 save() 以将其保存到数据库中</span></span><br><span class="line">q = Question(question_text=<span class="string">"What's new?"</span>, pub_date=timezone.now())</span><br><span class="line"><span class="comment"># 创建和保存对象则使用 create() 方法</span></span><br><span class="line">q.save()</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="更新对象"><a href="#更新对象" class="headerlink" title="更新对象"></a>更新对象</h5><ul>
<li><p>UPDATE 在幕后执行 SQL 语句：</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 保存对象的更改</span></span><br><span class="line">q.question = <span class="string">"What do you think about?"</span></span><br><span class="line">q.save()</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>保存 ForeignKey 字段：更新 ForeignKey 字段的工作方式与保存普通字段的方式完全相同，只需将正确类型的对象分配给相关字段即可。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一般情况 pk ( Primary Key ) 和 id 是一样的，只有 id 不是主键时才不一样</span></span><br><span class="line">choice = Choice.objects.get(pk=<span class="number">1</span>)</span><br><span class="line">question = Question.objects.get(<span class="string">'What do you think about?'</span>)</span><br><span class="line">choice.question = question</span><br><span class="line">choice.save()</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>更新ManyToManyField 工作的方式略有不同 ：使用 add() 字段上的方法向关系添加记录。</li>
</ul>
<h5 id="检索对象"><a href="#检索对象" class="headerlink" title="检索对象"></a>检索对象</h5><ul>
<li><p>使用 all() 返回所有对象：例如，返回 Question 数据库中所有对象。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">all_question = Question.objects.all()</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>使用过滤器检索特定对象</code>：若我们仅需要选择整个对象集的子集，则需要向 QuerySet 添加过滤条件。两种最常见的改进方法：</p>
<ul>
<li><code>filter(**kwargs)</code>：返回 QuerySet 包含与给定查找参数匹配的新对象。</li>
<li><p><code>exclude(**kwargs)</code>：返回 QuerySet 包含与给定查找参数不匹配的新对象。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 例如：获取 2018 年间所有问题记录</span></span><br><span class="line">Question.objects.filter(pub_date__year=<span class="number">2017</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li><p><code>链接过滤器</code>：QuerySet 检索结果本身也是 QuerySet 对象，故可使用多个过滤器。作用与 <code>多条件查询</code> 类似效果。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 例如：获取以“What”开头，在 2018 年 1 月 1 日至当天前的所有记录</span></span><br><span class="line">Question.objects.filter(</span><br><span class="line">	headline__startswith=<span class="string">'What'</span></span><br><span class="line">).exclude(</span><br><span class="line">	pub_date__gte=datetime.date.today()</span><br><span class="line">).filter(</span><br><span class="line">	pub_date__gte=datetime.date(<span class="number">2018</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>使用 get() 检索单个对象：</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">one_question = Question.objects.get(pk=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># Question 没有主键为 1 的对象，Django 将引发异常 Entry.DoesNotExist。</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>限制 QuerySet 返回集合的大小：使用 Python 的数组切片语法将限制 QuerySet 为一定数量的结果。这相当于 SQL 中 <code>LIMIT</code> 和 <code>OFFSET</code> 子句。</p>
<ul>
<li>注意 1：<code>Entry.objects.all()[-1]</code> 不支持负索引。</li>
<li><p>注意 2：<code>Entry.objects.all()[:10:2]</code> 不支持使用步进 ( Step ) 取值。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 例如：返回前5个对象（）：LIMIT 5</span></span><br><span class="line">Question.objects.all()[:<span class="number">5</span>]</span><br><span class="line"><span class="comment"># 例如：返回第6到第10个对象：OFFSET 5 LIMIT 5</span></span><br><span class="line">Question.objects.all()[<span class="number">5</span>:<span class="number">10</span>]</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="站点管理"><a href="#站点管理" class="headerlink" title="站点管理"></a>站点管理</h4><h5 id="开篇引言"><a href="#开篇引言" class="headerlink" title="开篇引言"></a>开篇引言</h5><ul>
<li>相信你也有过同样的经历，例如为你的员工或客户生成一个用户添加、修改和删除内容的管理后台，即简单的增删改查操作 ( CRUD ) ，但它却是一项缺乏创造性和乏味的工作。因此，Django 全自动地根据模型创建界面化的管理后台。</li>
<li>管理界面不是为了网站的访问者，而是为管理者准备的。需要客制化的后台管理界面还需自行实现。</li>
</ul>
<h5 id="创建管理员账号"><a href="#创建管理员账号" class="headerlink" title="创建管理员账号"></a>创建管理员账号</h5><ul>
<li><p>首先，我们得创建一个能登录管理页面的用户。请运行下面的命令：</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">python manage.py createsuperuser</span><br><span class="line"><span class="comment"># Username: kofe</span></span><br><span class="line"><span class="comment"># Email address: kofe@example.com</span></span><br><span class="line"><span class="comment"># Password: **********</span></span><br><span class="line"><span class="comment"># Password (again): *********</span></span><br><span class="line"><span class="comment"># Superuser created successfully.</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="启动开发服务器"><a href="#启动开发服务器" class="headerlink" title="启动开发服务器"></a>启动开发服务器</h5><ul>
<li><p>Django 的管理界面默认就是启用的。让我们启动开发服务器。当然，你可以通过 PyCharm 启动服务器，也可以通过命令启动：</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py runserver</span><br></pre></td></tr></table></figure>
</li>
<li><p>打开浏览器即可访问：<code>http://127.0.0.1:8000/admin/</code></p>
</li>
</ul>
<h5 id="管理页添加应用"><a href="#管理页添加应用" class="headerlink" title="管理页添加应用"></a>管理页添加应用</h5><ul>
<li><p>在索引页面中，我们并没有看到应用，如本例中的投票应用 <code>polls</code>。所以我们得告诉管理页面，问题 <code>Question</code> 对象需要被管理。打开 <code>polls/admin.py</code> 文件，把它编辑成下面这样：</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Question</span><br><span class="line">admin.site.register(Question)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="模板和视图"><a href="#模板和视图" class="headerlink" title="模板和视图"></a>模板和视图</h3><h4 id="开篇引言-1"><a href="#开篇引言-1" class="headerlink" title="开篇引言"></a>开篇引言</h4><ul>
<li><p>每个视图必须要做的只有两件事：返回一个包含被请求页面内容的 <code>HttpResponse</code> 对象或者抛出一个 <code>异常</code>，比如 HTTP 404。</p>
<blockquote>
<p>Django 只要求返回的是一个 HttpResponse ，或抛出一个异常。</p>
</blockquote>
</li>
<li><p>视图可以从数据库里读取记录，可使用一个模板引擎 ( Django 自带或者其他第三方的 )，生成一个 PDF 文件、输出一个 XML、创建一个 ZIP 文件等，你可以使用任何你想用的 Python 库，实现你想做的事。</p>
</li>
<li><p>Django 自带的 <a href="https://docs.djangoproject.com/zh-hans/2.1/topics/db/queries/" target="_blank" rel="noopener">Database API</a> 很方便，与试图结合使用即可实现数据的基本交互操作。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 index() 函数里插入了一些新内容</span></span><br><span class="line"><span class="comment"># 让它能展示数据库里以发布日期排序的最近5个投票问题</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Question</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">	latest_question_list = Question.objects.order_by(<span class="string">'-pub_date'</span>)[<span class="number">0</span>:<span class="number">5</span>]</span><br><span class="line">	output = <span class="string">', '</span>.join([q.question_text <span class="keyword">for</span> q <span class="keyword">in</span> latest_question_list])</span><br><span class="line">	<span class="keyword">return</span> HttpResponse(output)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="模板系统"><a href="#模板系统" class="headerlink" title="模板系统"></a>模板系统</h4><ul>
<li><p>这里有个问题：页面的设计写死在视图函数的代码里的。如果你想改变页面的样子，你需要编辑 Python 代码。我们是否能将此过程相互分离，即 <code>视图负责处理、组装数据</code>；<code>模板则负责样式</code>。</p>
<ul>
<li>首先，在你的项目根目录里创建一个 <code>templates</code> 目录。Django 将会在这个目录里查找模板文件。</li>
<li>在 <code>templates</code> 目录里，再创建一个目录 <code>polls</code>，然后在其中新建一个文件 <code>index.html</code>。</li>
<li><p>换句话说，你的模板文件的路径应该是 <code>mysite/templates/polls/index.html</code>。因为 Django 会寻找到对应的 <code>app_directories</code>，所以你只需要使用 <code>polls/index.html</code> 就可引用到这一模板了。</p>
<blockquote>
<p><code>模板命名空间</code>：虽然可将模板文件直接放在 mysite/templates 目录下，但若有一个模板文件正好和另一个应用中的某个模板文件重名，则 Django 没有办法区分它们，从而选择第一个匹配的模板文件，造成不能准确匹配的状况。</p>
<p>帮助 Django 正确选择模板，最简单的方法是把他们放入各自的 <code>命名空间</code> 中，即把这些模板放入一个和 <code>自身应用重名</code> 的子文件夹里，如本例中的 <code>polls</code>。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h4 id="小试牛刀"><a href="#小试牛刀" class="headerlink" title="小试牛刀"></a>小试牛刀</h4><ul>
<li><p>我们将下面的代码输入到刚刚创建的模板文件中：</p>
  <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- mysite/templates/polls/index.html --&gt;</span></span><br><span class="line">&#123;% if latest_question_list %&#125;</span><br><span class="line">	<span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">	&#123;% for question in latest_question_list %&#125;</span><br><span class="line">		<span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/polls/&#123;&#123; question.id &#125;&#125;/"</span>&gt;</span></span><br><span class="line">			&#123;&#123; question.question_text &#125;&#125;</span><br><span class="line">		<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">	&#123;% endfor %&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">	<span class="tag">&lt;<span class="name">p</span>&gt;</span>No polls are available.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>然后，让我们更新一下 polls/views.py 里的 index 视图来使用模板：</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">from</span> django.template <span class="keyword">import</span> loader</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Question</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">	latest_question_list = Question.objects.order_by(<span class="string">'-pub_date'</span>)[:<span class="number">5</span>]</span><br><span class="line">	template = loader.get_template(<span class="string">'polls/index.html'</span>)</span><br><span class="line">	context = &#123;</span><br><span class="line">		<span class="string">'latest_question_list'</span>: latest_question_list,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> HttpResponse(template.render(context, request))</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>载入模板，填充上下文，再返回由它生成的 HttpResponse 对象，这里引入一个便捷函数 render() 函数。它已经把此过程封装一起，调用即可使用。</p>
<p>  render() 函数的第一个参数是 request 对象，第二个参数是模板名，第三个参数是字典。它返回给定上下文呈现的给定模板的 HttpResponse 对象。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">	latest_question_list = Question.objects.order_by(<span class="string">'-pub_date'</span>)[:<span class="number">5</span>]</span><br><span class="line">	context = &#123;<span class="string">'latest_question_list'</span>: latest_question_list&#125;</span><br><span class="line">	<span class="keyword">return</span> render(request, <span class="string">'polls/index.html'</span>, context)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>用你的浏览器访问 <code>http://127.0.0.1:8000/polls/</code>，你将会看见一个无序列表。</li>
</ul>
<h4 id="使用模板系统"><a href="#使用模板系统" class="headerlink" title="使用模板系统"></a>使用模板系统</h4><blockquote>
<p>使用模板系统的过程，更像是前端与后端信息交互的过程，即前端访问请求地址获取数据的过程。</p>
</blockquote>
<ul>
<li>模板系统统一使用 <code>点符号</code> 来访问变量的属性。在示例 {{ question.question_text }} 中，首先 Django 尝试对 question 对象使用字典查找 ( 也就是使用 obj.get(str) 操作 )，如果失败了就尝试属性查找 ( 也就是 obj.str 操作 )，结果是成功了。如果这一操作也失败的话，将会尝试列表查找 ( 也就是 obj[int] 操作 )。</li>
<li>在{% for %}循环中发生的函数调用：question.choice_set.all 被解释为 Python 代码 question.choice_set.all()，将会返回一个可迭代的 Choice 对象，这一对象可以在 {% for %} 标签内部使用。</li>
<li>查看 <a href="https://docs.djangoproject.com/zh-hans/2.1/topics/templates/" target="_blank" rel="noopener">模板指南</a> 可以了解关于模板的更多信息。</li>
</ul>
<h4 id="去除模板中的硬编码-URL"><a href="#去除模板中的硬编码-URL" class="headerlink" title="去除模板中的硬编码 URL"></a>去除模板中的硬编码 URL</h4><ul>
<li><p>硬编码：硬编码和强耦合的链接，对于一个包含很多应用的项目来说，修改起来是十分困难的。</p>
  <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/polls/&#123;&#123; question.id &#125;&#125;/"</span>&gt;</span></span><br><span class="line">	&#123;&#123; question.question_text &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>软编码：然而，因为你在 polls.urls 的 url() 函数中通过 name 参数为 URL 定义了名字，你可以使用 {% url %} 标签代替它。</p>
  <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment"> | 具有名字 'detail' 的 URL 在 polls/url.py 中定义为：</span></span><br><span class="line"><span class="comment"> | path('&lt;int:question_id&gt;/', views.detail, name='detail')</span></span><br><span class="line"><span class="comment">--&gt;</span>	</span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'detail' question.id %&#125;"</span>&gt;</span></span><br><span class="line">	&#123;&#123; question.question_text &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment"> | 若你想改变投票详情视图的 URL，比如 polls/specifics/12/</span></span><br><span class="line"><span class="comment"> | 不用在模板里修改任何东西 (包括模板)，只在 polls/urls.py 稍微修改就行</span></span><br><span class="line"><span class="comment"> | path('specifics/&lt;int:question_id&gt;/', views.detail, name='detail')</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="为-URL-名称添加命名空间"><a href="#为-URL-名称添加命名空间" class="headerlink" title="为 URL 名称添加命名空间"></a>为 URL 名称添加命名空间</h4><ul>
<li>在一个真实的 Django 项目中，可能会有多个应用，Django 如何分辨重名的 URL 呢？具体情况则是，{% url %} 标签到底对应哪一个应用的 URL 呢？</li>
<li><p>在根 <code>URLconf</code> 中添加命名空间。在 polls/urls.py 文件中稍作修改，加上 <code>app_name</code> 设置命名空间：</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line">app_name = <span class="string">'polls'</span></span><br><span class="line">urlpatterns = [</span><br><span class="line">	path(<span class="string">''</span>, views.index, name=<span class="string">'index'</span>),</span><br><span class="line">	path(<span class="string">'&lt;int:question_id&gt;/'</span>, views.detail, name=<span class="string">'detail'</span>),</span><br><span class="line">	path(<span class="string">'&lt;int:question_id&gt;/results/'</span>, views.results, name=<span class="string">'results'</span>),</span><br><span class="line">	path(<span class="string">'&lt;int:question_id&gt;/vote/'</span>, views.vote, name=<span class="string">'vote'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>修改为指向具有命名空间的详细视图：</p>
  <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'polls:detail' question.id %&#125;"</span>&gt;</span></span><br><span class="line">	&#123;&#123; question.question_text &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="表单和通用视图"><a href="#表单和通用视图" class="headerlink" title="表单和通用视图"></a>表单和通用视图</h3><h4 id="表单"><a href="#表单" class="headerlink" title="表单"></a>表单</h4><blockquote>
<p>在此小节中，通过表单接收数据，再通过 Django 视图来处理提交的数据。此过程，更像是前端打包数据通过 GET/POST 请求，把数据传送到后端，交由后端视图处理数据。</p>
</blockquote>
<ul>
<li><p>编写一个简单的表单：让我们更新一下在上一个教程中编写的投票详细页面的模板  <code>polls/detail.html</code>，让它包含一个 HTML <code>&lt;form&gt;</code> 元素：</p>
  <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- mystie/templates/polls/detail.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123; question.question_text &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">&#123;% if error_message %&#125;</span><br><span class="line">	<span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">strong</span>&gt;</span>&#123;&#123; error_message &#125;&#125;<span class="tag">&lt;/<span class="name">strong</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"&#123;% url 'polls:vote' question.id %&#125;"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment"> | 跨站点请求伪造保护：</span></span><br><span class="line"><span class="comment"> | 在 Django 中，所有针对内部 URL 的 POST 表单，</span></span><br><span class="line"><span class="comment"> | 都应该使用  &#123;% csrf_token %&#125; 模板标签。</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line">&#123;% csrf_token %&#125;</span><br><span class="line">&#123;% for choice in question.choice_set.all %&#125;</span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"choice"</span> <span class="attr">id</span>=<span class="string">"choice&#123;&#123; forloop.counter &#125;&#125;"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123; choice.id &#125;&#125;"</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 指示 for 标签已经循环多少次 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"choice&#123;&#123; forloop.counter &#125;&#125;"</span>&gt;</span>&#123;&#123; choice.choice_text &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Vote"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="https://docs.djangoproject.com/zh-hans/2.1/ref/csrf/" target="_blank" rel="noopener">跨站点请求伪造保护</a>：当恶意网站包含链接，表单按钮或某些旨在在您的网站上执行某些操作的JavaScript时，会发生此类攻击，使用登录用户访问其浏览器中的恶意网站的凭据。一种相关类型的攻击，“登录CSRF”，攻击网站欺骗用户的浏览器以其他人的凭据登录网站也受到保护。</p>
</blockquote>
</li>
<li><p>我们为投票应用创建了一个 URLconf ，即新增一行 <code>path()</code>：</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/urls.py</span></span><br><span class="line">path(<span class="string">'&lt;int:question_id&gt;/vote/'</span>, views.vote, name=<span class="string">'vote'</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>创建一个 <code>vote()</code> 函数，来处理相关的数据请求：</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse, HttpResponseRedirect</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> get_object_or_404, render</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> reverse</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Choice, Question</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vote</span><span class="params">(request, question_id)</span>:</span></span><br><span class="line">	question = get_object_or_404(Question, pk=question_id)</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		selected_choice = question.choice_set.get(pk=request.POST[<span class="string">'choice'</span>])</span><br><span class="line">	<span class="keyword">except</span> (KeyError, Choice.DoesNotExist):</span><br><span class="line">		<span class="comment"># Redisplay the question voting form.</span></span><br><span class="line">		<span class="keyword">return</span> render(request, <span class="string">'polls/detail.html'</span>, &#123;</span><br><span class="line">			<span class="string">'question'</span>: question,</span><br><span class="line">			<span class="string">'error_message'</span>: <span class="string">"You didn't select a choice."</span>,</span><br><span class="line">		&#125;)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		selected_choice.votes += <span class="number">1</span></span><br><span class="line">		selected_choice.save()</span><br><span class="line">		<span class="comment"># Always return an HttpResponseRedirect after successfully dealing</span></span><br><span class="line">		<span class="comment"># with POST data. This prevents data from being posted twice if a</span></span><br><span class="line">		<span class="comment"># user hits the Back button.</span></span><br><span class="line">		<span class="keyword">return</span> HttpResponseRedirect(reverse(<span class="string">'polls:results'</span>, args=(question.id,)))</span><br></pre></td></tr></table></figure>
<ul>
<li>代码返回一个 HttpResponseRedirect 而不是常用的 HttpResponse；</li>
<li>HttpResponseRedirect 只接收一个参数：用户将要被重定向的 URL；</li>
<li><p>在 HttpResponseRedirect 的构造函数中使用 reverse() 函数。这个函数避免了我们在视图函数中硬编码 URL。</p>
<blockquote>
<p>reverse() 调用将返回一个这样的字符串 <code>/polls/3/results/</code>。<br>其中 3 是 question.id 的值。重定向的 URL 将调用 ‘results’ 视图来显示最终的页面。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>当对 Question 进行投票后，vote() 视图将请求重定向到 Question 的结果界面。让我们来编写这个视图 ( 这和上一章节中的 detail() 视图几乎一模一样，唯一的不同是模板的名字。 我们将在稍后解决这个冗余问题 )：</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> get_object_or_404, render</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">results</span><span class="params">(request, question_id)</span>:</span></span><br><span class="line">	question = get_object_or_404(Question, pk=question_id)</span><br><span class="line">	<span class="keyword">return</span> render(request, <span class="string">'polls/results.html'</span>, &#123;<span class="string">'question'</span>: question&#125;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>再创建一个 <code>polls/results.html</code> 模板：</p>
  <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- polls/templates/polls/results.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123; question.question_text &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">&#123;% for choice in question.choice_set.all %&#125;<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">	&#123;&#123; choice.choice_text &#125;&#125; -- &#123;&#123; choice.votes &#125;&#125; vote&#123;&#123; choice.votes|pluralize &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span>&#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'polls:detail' question.id %&#125;"</span>&gt;</span>Vote again?<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="通用视图"><a href="#通用视图" class="headerlink" title="通用视图"></a>通用视图</h4><blockquote>
<p>猜想：通用视图是否是通用模板的思想，即使用统一的界面展示数据？</p>
</blockquote>
<ul>
<li>detail() 和 results() 视图都很简单。并且，像上面提到的那样，存在冗余问题。</li>
<li>这些视图反映基本的 Web 开发中的一个常见情况：根据 URL 中的参数从数据库中获取数据、载入模板文件然后返回渲染后的模板。 由于这种情况特别常见，Django 提供一种快捷方式，叫做“通用视图”系统。</li>
<li><p>通用视图将常见的模式抽象化，可以使你在编写应用时甚至不需要编写 Python 代码。</p>
<blockquote>
<p>一般来说，当编写一个 Django 应用时，你应该先评估一下通用视图是否可以解决你的问题，你应该在一开始使用它，而不是进行到一半时重构代码。</p>
</blockquote>
</li>
<li><p>让我们将我们的投票应用转换成使用通用视图系统，这样我们可以删除许多我们的代码。我们仅仅需要做以下几步来完成转换，我们将：</p>
<ul>
<li>转换 URLconf。</li>
<li>删除一些旧的、不再需要的视图。</li>
<li>基于 Django 的通用视图引入新的视图。</li>
</ul>
</li>
</ul>
<h5 id="改良-URLconf"><a href="#改良-URLconf" class="headerlink" title="改良 URLconf"></a>改良 URLconf</h5><ul>
<li><p>首先，打开 polls/urls.py 这个 URLconf 并将它修改成：</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">app_name = <span class="string">'polls'</span></span><br><span class="line">urlpatterns = [</span><br><span class="line">	path(<span class="string">''</span>, views.IndexView.as_view(), name=<span class="string">'index'</span>),</span><br><span class="line">	<span class="comment"># 路径字符串中匹配模式的名称已经由 &lt;question_id&gt; 改为 &lt;pk&gt;</span></span><br><span class="line">	path(<span class="string">'&lt;int:pk&gt;/'</span>, views.DetailView.as_view(), name=<span class="string">'detail'</span>),</span><br><span class="line">	path(<span class="string">'&lt;int:pk&gt;/results/'</span>, views.ResultsView.as_view(), name=<span class="string">'results'</span>),</span><br><span class="line">	path(<span class="string">'&lt;int:question_id&gt;/vote/'</span>, views.vote, name=<span class="string">'vote'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="改良视图"><a href="#改良视图" class="headerlink" title="改良视图"></a>改良视图</h5><ul>
<li><p>下一步，我们将删除旧的 index, detail, 和 results 视图，并用 Django 的通用视图代替。打开 polls/views.py 文件，并将它修改成：</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponseRedirect</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> get_object_or_404, render</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> reverse</span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> generic</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Choice, Question</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexView</span><span class="params">(generic.ListView)</span>:</span></span><br><span class="line">	template_name = <span class="string">'polls/index.html'</span></span><br><span class="line">	context_object_name = <span class="string">'latest_question_list'</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span><span class="params">(self)</span>:</span></span><br><span class="line">       		<span class="comment"># Return the last five published questions.</span></span><br><span class="line">       		<span class="keyword">return</span> Question.objects.order_by(<span class="string">'-pub_date'</span>)[:<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DetailView</span><span class="params">(generic.DetailView)</span>:</span></span><br><span class="line">	model = Question</span><br><span class="line">	template_name = <span class="string">'polls/detail.html'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResultsView</span><span class="params">(generic.DetailView)</span>:</span></span><br><span class="line">	model = Question</span><br><span class="line">	template_name = <span class="string">'polls/results.html'</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">vote</span><span class="params">(request, question_id)</span>:</span></span><br><span class="line">		<span class="comment"># Same as above, no changes needed.</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>上述代码详细解释：        </p>
<ul>
<li>默认情况下，通用视图 DetailView 使用一个叫做 <code>&lt;app name&gt;/&lt;model name&gt;_detail.html</code> 的模板。在我们的例子中，它将使用 <code>polls/question_detail.html</code> 模板。</li>
<li><code>template_name</code> 属性是用来告诉 Django 使用一个指定的模板名字，而不是自动生成的默认名字。 </li>
<li>我们也为 results 列表视图和 detail 视图指定了 template_name。即使它们在后台都是同一个 DetailView，results 视图和 detail 视图在渲染时具有不同的访问名称。</li>
<li>类似地，ListView 使用一个叫做 <code>&lt;app name&gt;/&lt;model name&gt;_list.html</code> 的默认模板；我们使用 template_name 来告诉 ListView 使用我们创建的已经存在的 <code>polls/index.html</code> 模板。</li>
<li>在之前的教程中，提供模板文件时都带有一个包含 question 和 latest_question_list 变量的 context。<ul>
<li>对于 DetailView ， question 变量会自动提供—— 因为我们使用 Django 的模型 (Question)， Django 能够为 context 变量决定一个合适的名字。</li>
<li>对于 ListView， 自动生成的 context 变量是 question_list。为了覆盖这个行为，我们提供 <code>context_object_name</code> 属性，表示我们想使用 <code>latest_question_list</code>。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="自动化测试"><a href="#自动化测试" class="headerlink" title="自动化测试"></a>自动化测试</h3><h4 id="为什么你需要写测试"><a href="#为什么你需要写测试" class="headerlink" title="为什么你需要写测试"></a>为什么你需要写测试</h4><ul>
<li><code>测试将节约你的时间</code>：在复杂的应用程序中，组件之间可能会有数十个复杂的交互。改变其中某一组件的行为，也有可能会造成意想不到的结果。判断「代码是否正常工作」意味着你需要用大量的数据来完整的测试全部代码的功能，以确保你的小修改没有对应用整体造成破坏，可想而知其中的工作量。</li>
<li><code>测试不仅能发现错误且能预防错误</code>：测试是开发的对立面，这种思想是不对的，开发其实更像是一个不断试错的过程。</li>
</ul>
<h4 id="开始写一个测试程序"><a href="#开始写一个测试程序" class="headerlink" title="开始写一个测试程序"></a>开始写一个测试程序</h4><ul>
<li>约定俗称，Django 应用的测试应该写在应用的 <code>tests.py</code> 文件里，测试系统会自动的在所有以 tests 开头的文件里寻找并执行测试代码。</li>
<li><p>制造一个 BUG：继续上述提及的应用 Polls，要求 Question 是在一天之内发布， 则 Question.was_published_recently() 方法将会返回 True 。然而现在这个方法在 Question 的 pub_date 字段比当前时间还晚 ( 未来的时间 ) 时也会返回 True。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</span><br><span class="line"><span class="keyword">from</span> polls.models <span class="keyword">import</span> Question</span><br><span class="line"><span class="comment"># create a Question instance with pub_date 30 days in the future</span></span><br><span class="line">time = timezone.now() + datetime.timedelta(days=<span class="number">30</span>)</span><br><span class="line">future_question = Question(pub_date=time)</span><br><span class="line"><span class="comment"># was it published recently? ==&gt; True</span></span><br><span class="line">future_question.was_published_recently()</span><br></pre></td></tr></table></figure>
</li>
<li><p>创造一个测试用例：创建一个 <code>django.test.TestCase</code> 的子类。</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Question</span><br><span class="line"><span class="keyword">from</span> django.test <span class="keyword">import</span> TestCase</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuestionModelTests</span><span class="params">(TestCase)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_was_published_recently_with_future_question</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        was_published_recently() returns False </span></span><br><span class="line"><span class="string">        for questions whose pub_date is in the future.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        time = timezone.now() + datetime.timedelta(days=<span class="number">30</span>)</span><br><span class="line">        future_question = Question(pub_date=time)</span><br><span class="line">        self.assertIs(future_question.was_published_recently(), <span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，我们可通过 PyCharm 单独运行测试用例，也可以通过终端命令运行自动化测试。</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py <span class="built_in">test</span> polls</span><br></pre></td></tr></table></figure>
</li>
<li><p>发生了什么呢？以下是自动化测试的运行过程：</p>
<ul>
<li><code>python manage.py test polls</code> 将会寻找 Polls 应用里的测试代码，它找到了 django.test.TestCase 的一个子类，并创建一个特殊的数据库供测试使用；</li>
<li>在类中寻找测试方法 ( 以 test 开头的 )，在 <code>test_was_published_recently_with_future_question</code> 方法中，它创建了一个 pub_date 值为 30 天后的 Question 实例。</li>
<li>接着使用 <code>assertls()</code> 方法，发现 <code>was_published_recently()</code> 返回了 True，而我们期望它返回 False。</li>
</ul>
</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li>[1] <a href="https://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/001432712108300322c61f256c74803b43bfd65c6f8d0d0000" target="_blank" rel="noopener">廖雪峰. Python 教程之 virtualenv. 2017. liaoxuefeng.com</a></li>
<li>[2] <a href="https://zhuanlan.zhihu.com/p/31447222" target="_blank" rel="noopener">地球的外星人君. Python Web 框架大乱斗：哪个框架适合你. 2017. zhihu.com</a></li>
<li>[3] <a href="https://www.zhihu.com/question/20706333" target="_blank" rel="noopener">知乎问答. Python 有哪些好的 Web 框架. zhihu.com</a></li>
</ul>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Kofe
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://www.kofes.cn/2019/02/Django.html" title="Django：Web 框架从入门到应用">http://www.kofes.cn/2019/02/Django.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/python/" rel="tag"># python</a>
          
            <a href="/tags/web/" rel="tag"># web</a>
          
            <a href="/tags/django/" rel="tag"># django</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/02/FastDFS.html" rel="next" title="FastDFS：文件系统从入门到应用">
                <i class="fa fa-chevron-left"></i> FastDFS：文件系统从入门到应用
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/08/root-cause-analysis-alarm-clustering.html" rel="prev" title="论文 | 基于根因分析的报警聚类算法">
                论文 | 基于根因分析的报警聚类算法 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/profile/society_face_version_1.jpg" alt="Kofe">
            
              <p class="site-author-name" itemprop="name">Kofe</p>
              <p class="site-description motion-element" itemprop="description">融合工程、美学、数据的思维及能力，<br>创作最优质内容，愿与粉丝共进步、共成长。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">44</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">171</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/ldxw8" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://dribbble.com/Kofe" target="_blank" title="Dribbble">
                      
                        <i class="fa fa-fw fa-dribbble"></i>Dribbble</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://weibo.com/ldxw8" target="_blank" title="Weibo">
                      
                        <i class="fa fa-fw fa-weibo"></i>Weibo</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.acxer.cn" title="zcxer" target="_blank">zcxer</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#教学资源"><span class="nav-number">1.</span> <span class="nav-text">教学资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#快速上手"><span class="nav-number">2.</span> <span class="nav-text">快速上手</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装与配置"><span class="nav-number">2.1.</span> <span class="nav-text">安装与配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#请求与响应"><span class="nav-number">2.2.</span> <span class="nav-text">请求与响应</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#返回内容至页面"><span class="nav-number">2.2.1.</span> <span class="nav-text">返回内容至页面</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#返回独立-Html-页面"><span class="nav-number">2.2.2.</span> <span class="nav-text">返回独立 Html 页面</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#简单登录功能"><span class="nav-number">2.3.</span> <span class="nav-text">简单登录功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#增删改查系统"><span class="nav-number">2.4.</span> <span class="nav-text">增删改查系统</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#建立数据表"><span class="nav-number">2.4.1.</span> <span class="nav-text">建立数据表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#前-后端交互原理"><span class="nav-number">2.4.2.</span> <span class="nav-text">前 / 后端交互原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#原生代码操作数据"><span class="nav-number">2.4.3.</span> <span class="nav-text">原生代码操作数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Ajax-方式交互数据"><span class="nav-number">2.4.4.</span> <span class="nav-text">Ajax 方式交互数据</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#框架正文"><span class="nav-number">3.</span> <span class="nav-text">框架正文</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据库配置"><span class="nav-number">3.1.</span> <span class="nav-text">数据库配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模型和站点管理"><span class="nav-number">3.2.</span> <span class="nav-text">模型和站点管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建模型"><span class="nav-number">3.2.1.</span> <span class="nav-text">创建模型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#激活模型"><span class="nav-number">3.2.2.</span> <span class="nav-text">激活模型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据操作"><span class="nav-number">3.2.3.</span> <span class="nav-text">数据操作</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#创建对象"><span class="nav-number">3.2.3.1.</span> <span class="nav-text">创建对象</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#更新对象"><span class="nav-number">3.2.3.2.</span> <span class="nav-text">更新对象</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#检索对象"><span class="nav-number">3.2.3.3.</span> <span class="nav-text">检索对象</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#站点管理"><span class="nav-number">3.2.4.</span> <span class="nav-text">站点管理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#开篇引言"><span class="nav-number">3.2.4.1.</span> <span class="nav-text">开篇引言</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#创建管理员账号"><span class="nav-number">3.2.4.2.</span> <span class="nav-text">创建管理员账号</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#启动开发服务器"><span class="nav-number">3.2.4.3.</span> <span class="nav-text">启动开发服务器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#管理页添加应用"><span class="nav-number">3.2.4.4.</span> <span class="nav-text">管理页添加应用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模板和视图"><span class="nav-number">3.3.</span> <span class="nav-text">模板和视图</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#开篇引言-1"><span class="nav-number">3.3.1.</span> <span class="nav-text">开篇引言</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#模板系统"><span class="nav-number">3.3.2.</span> <span class="nav-text">模板系统</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#小试牛刀"><span class="nav-number">3.3.3.</span> <span class="nav-text">小试牛刀</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用模板系统"><span class="nav-number">3.3.4.</span> <span class="nav-text">使用模板系统</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#去除模板中的硬编码-URL"><span class="nav-number">3.3.5.</span> <span class="nav-text">去除模板中的硬编码 URL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#为-URL-名称添加命名空间"><span class="nav-number">3.3.6.</span> <span class="nav-text">为 URL 名称添加命名空间</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#表单和通用视图"><span class="nav-number">3.4.</span> <span class="nav-text">表单和通用视图</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#表单"><span class="nav-number">3.4.1.</span> <span class="nav-text">表单</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通用视图"><span class="nav-number">3.4.2.</span> <span class="nav-text">通用视图</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#改良-URLconf"><span class="nav-number">3.4.2.1.</span> <span class="nav-text">改良 URLconf</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#改良视图"><span class="nav-number">3.4.2.2.</span> <span class="nav-text">改良视图</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自动化测试"><span class="nav-number">3.5.</span> <span class="nav-text">自动化测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#为什么你需要写测试"><span class="nav-number">3.5.1.</span> <span class="nav-text">为什么你需要写测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#开始写一个测试程序"><span class="nav-number">3.5.2.</span> <span class="nav-text">开始写一个测试程序</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">4.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kofe</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>








        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: true,
        notify: true,
        appId: 'STGXfYUEVVq1AoccxhumXjsB-gzGzoHsz',
        appKey: 'jbgIHEzUigo8apYgTon6xXE8',
        placeholder: '非常期待您的想法或意见，推荐留言~',
        avatar:'hide',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("STGXfYUEVVq1AoccxhumXjsB-gzGzoHsz", "jbgIHEzUigo8apYgTon6xXE8");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
